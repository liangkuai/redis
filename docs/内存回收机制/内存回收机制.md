# 内存回收机制


### 1. 过期策略 = 惰性删除 + 定期删除

#### 1.1 惰性删除

> 在被查询时，检查 key 是否过期，过期再删除。

问题就是可能会有很多过期的 key 没及时删除，占用内存。


#### 1.2 定期删除

> 周期性地随机抽查一批设置了过期时间的 key，检查其是否过期，过期就删除。

Redis 底层会通过限制删除操作执行的时长和频率来减少删除操作对 CPU 时间的影响。

- 如果定期删除执行时间已经超过了阈值，那么就中断这一次定期删除，避免使用过多的 CPU 时间。

- 如果这一批过期的 key 比例超过一个比例，就会重复进行定期删除，更积极地清理过期 key。相应地，如果过期的 key 比例低于这个比例，就会中断这一次定期删除，避免做过多的工作而获得很少的内存回收。

> Redis 7.2 版本的执行时间阈值是 25 ms，过期 key 比例设定值是 10%。

##### 1.2.1 每次随机抽查 key 的数量是多少？

Redis 7.2 版本为 20，每次会随机选择 20 个设置了过期时间的 key 判断是否过期。

##### 1.2.2 如何控制定期删除的执行频率？

在 Redis 中，定期删除的频率是由 `hz` 参数控制的。`hz` 默认为 10，代表每秒执行 10 次，也就是每秒钟进行 10 次尝试来查找并删除过期的 key。

`hz` 的取值范围为 1~500。增大 `hz` 参数的值会提升定期删除的频率。如果想要更频繁地执行定期删除任务，可以适当增加 hz 的值，但这会增加 CPU 的负载。根据 Redis 官方建议，`hz` 的值不建议超过 100，对于大部分用户使用默认的 10 就足够了。

Redis 6.0 开始还有一个类似的参数 `dynamic-hz`，开启之后 Redis 就会在 `hz` 的基础上动态计算一个值。

```properties
# 默认为 10
hz 10
# 默认开启
dynamic-hz yes
```


### 2. 内存淘汰策略

Redis 的内存淘汰策略只有在运行内存达到了配置的最大内存阈值时才会触发。

这个阈值是通过 `redis.conf` 的 `maxmemory`参数来定义的。

- 64 位操作系统下，`maxmemory` 默认为 0 ，表示不限制内存大小。
- 32 位操作系统下，默认的最大内存值是 3GB。


| 策略 | 含义 |
| :-- | :-- |
| `volatile-lru` | 从已设置过期时间的数据集 `server.db[i].expires` 中挑选最近最少使用的数据淘汰。 |
| `volatile-ttl` | 从已设置过期时间的数据集 `server.db[i].expires` 中挑选将要过期的数据淘汰。 |
| `volatile-random` | 从已设置过期时间的数据集 `server.db[i].expires` 中任意选择数据淘汰。 |
| `allkeys-lru` | 当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 key。 |
| `allkeys-random` | 从数据集 `server.db[i].dict` 中任意选择数据淘汰。 |
| `no-eviction` | 默认。禁止驱逐数据，也就是说当内存不足以容纳新写入数据时，新写入操作会报错。 |
| `volatile-lfu` | 从已设置过期时间的数据集 `server.db[i].expires` 中挑选最不经常使用的数据淘汰。（4.0 版本后） |
| `allkeys-lfu` | 当内存不足以容纳新写入数据时，在键空间中，移除最不经常使用的 key。（4.0 版本后） |

- lru，least recently used，最近最少使用
- lfu，least frequently used，最不经常使用


---

### FAQ

#### 1. 如何判断 key 过期？

Redis 通过一个叫过期字典的结构（可以看作是 hash 表）来保存 key 的过期时间，也就是 `redisDB.expires`。

```c
typedef struct redisDb {
    dict *dirct;        // 数据库键空间，保存所有键值对
    dict *expires;      // 过期字典，保存键的过期时间
    ...
}
```

`expires` 里也是键值对，
- key 和键空间里的 key 指向同一个键对象，
- value 保存的就是 key 所指向的键对象的过期时间（毫秒精度的 UNIX 时间戳）。

**判断过期就是通过查询过期字典，判断 key 存在且当前 UNIX 时间戳大于过期时间。**


#### 2. 大量 key 集中过期怎么办？

如果存在大量 key 集中过期的问题，可能会使 Redis 的请求延迟变高。

1. 尽量避免 key 集中过期，在设置键的过期时间时尽量随机一点。

2. 对过期的 key 开启 lazyfree 机制（修改 redis.conf 中的 `lazyfree-lazy-expire` 参数即可），这样会在后台异步删除过期的 key，不会阻塞主线程的运行。
